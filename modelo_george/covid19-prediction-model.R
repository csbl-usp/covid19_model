# x <- seq(from = 0.01, to = 50, by = 0.01)

FunLoopSIR3RoSIR <- function(Si, Ii, gamma, Ro1, Ro2, Ro3, iquarant, durationq, x){
  S = c()
  I = c()
  R = c()
  beta1 <- Ro1*gamma;    beta2 <- Ro2*gamma; beta3 <- Ro3*gamma
  N <- length(x)
  S[1] <- Si;  I[1] <- Ii;  R[1] <- 1 - S[1] - I[1]
  for (i in 1:(N-1)){
    dt <- 10^-1
    S[i+1] <- S[i] -  beta1*S[i]*I[i]*dt
    I[i+1] <- 1 - S[i+1] - R[i]
    R[i+1] <- R[i] + gamma*I[i]*dt
    if (i  > iquarant*(1/0.01)) {
      S[i+1] <- S[i] -  beta2*S[i]*I[i]*dt
      I[i+1] <- 1 - S[i+1] - R[i]
      R[i+1] <- R[i] + gamma*I[i]*dt
    }
    if (i  > (iquarant+durationq)*(1/0.01)){
      S[i+1] <- S[i] -  beta3*S[i]*I[i]*dt
      I[i+1] <- 1 - S[i+1] - R[i]
      R[i+1] <- R[i] + gamma*I[i]*dt
    }
  }

  dataframe <- data.frame(col1=S, col2 = I, col3 = R)
  colnames(dataframe) = c("S","I","R")
  return(dataframe)
}

# N = 50 #não precisa declarar N pois já é declarado dentro da função FunLoopSIR3RoSIR de acordo com X
########### MODEL PARAMETERS GENERATED BY MATLAB SCRIPT ######################
parsItaly <- c(0.1001, 1.0882, 1.3197, 2.0000, 25.4713, 50.0000)
parsIran <- c(0.1001, 1.0841, 1.3151, 2.0000, 25.4713, 50.0000)
parsHubei <- c(0.4135, 1.1003, 0.5005, 2.0000, 25.4655, 50.0000)
parsKorea <- c(0.1000, 1.2552, 1.0990, 2.0000, 25.4710, 50.0000)

locations <- c("pars1","pars2","pars3","pars4","pars5","pars6")
locDF <- data.frame(parsItaly, parsHubei, parsKorea, parsIran)
rownames(locDF) <- locations

#x <- seq(from = 0.01, to = 50, by = 0.01)
x <- seq(from = 0.01, to = 120, by = 0.01)

TotalPop <- as.numeric(10^7)
InitCases <- as.numeric(100)
Si <- (TotalPop-InitCases)/TotalPop
Ii <- InitCases/TotalPop
pars <- locDF[, as.numeric(1)]

SIR = FunLoopSIR3RoSIR(Si, Ii, pars[1], pars[2], pars[3], pars[3], pars[5], pars[6], x)

library(plotly)
SIR$time_range <- factor(SIR$time_range, levels = SIR[["time_range"]])

#colocar no dataframe SIR
# x_plot <- seq(from = 0.01, to = 50, by = 0.01)
#
figure <- plot_ly(SIR, x = ~x, y = ~S,
                  name = 'Susceptibles', type = 'scatter',
                  mode = 'lines', line = list(color = 'rgb(205, 12, 24)', width = 4))
figure <- figure %>% add_trace(y = ~I*100, name = 'Infected', line = list(color = 'rgb(22, 96, 167)', width = 4))
figure <- figure %>% add_trace(y = ~R, name = 'Recovered', line = list(color = 'rgb(202, 96, 167)', width = 4))
figure <- figure %>% layout(title = "Main Title of the Plot",
                                 xaxis = list(title = "Title X axis"),
                                 yaxis = list(title = "Title Y axis"))
figure

library(plotly)
p1 <- plot_ly(SIR, x = ~x, y = ~R) %>% add_lines(name = ~"unemploy")
p2 <- plot_ly(SIR, x = ~x, y = ~I) %>% add_lines(name = ~"uempmed")
p <- subplot(p1, p2)
p

fig <- plot_ly(airquality_sept)
fig <- fig %>% add_trace(x = ~x, y = ~S, type = 'scatter', name = 'S',
                         marker = list(color = '#C9EFF9'),
                         hoverinfo = "text")
                         # ,text = ~paste(Wind, ' mph'))
fig <- fig %>% add_trace(x = ~Date, y = ~Temp, type = 'scatter', mode = 'lines', name = 'Temperature', yaxis = 'y2',
                         line = list(color = '#45171D'),
                         hoverinfo = "text",
                         text = ~paste(Temp, '°F'))
fig <- fig %>% layout(title = 'New York Wind and Temperature Measurements for September 1973',
                      xaxis = list(title = ""),
                      yaxis = list(side = 'left', title = 'Wind in mph', showgrid = FALSE, zeroline = FALSE),
                      yaxis2 = list(side = 'right', overlaying = "y", title = 'Temperature in degrees F', showgrid = FALSE, zeroline = FALSE))

fig

# Create a shareable link to your chart
# Set up API credentials: https://plot.ly/r/getting-started
chart_link <- plotly_POST(p, filename = "subplot/basic")
chart_link

############# PLOT DATA PO #############################


plot(x, 100 * SIR$R,'l', col="red",
     ylab ="Cumulativo dos casos (R) (% populacao)",
     xlab = "% Dias desde o inicio da contagem",
     main = 'Sao Paulo de acordo com Italia');

plot( x,100 * SIR$I,'l', col="blue",
      ylab = "% População Doente Simultaneamente",
      xlab = "% Dias desde o inicio da contagem",
      main = 'Sao Paulo de acordo com Italia'
      )




#x = 0.01:0.01:120;
parsItaly <- c(0.1001, 1.0882, 1.3197, 2.0000, 25.4713, 50.0000)
############TO PLOTLY IN INSIDE SHINY

# library(plotly)
#ui ------
#
#plotlyOutput('figure')


#in server ----

# SIR$time_range <- factor(SIR$time_range, levels = SIR[["time_range"]])
#
#
# output$figure <-
#   renderPlotly({
#     figure <- plot_ly(SIR, x = ~time_range,
#                       y = ~S, name = 'Susceptibles',
#                       type = 'scatter', mode = 'lines',
#                       line = list(color = 'rgb(205, 12, 24)', width = 4))
#     figure <- figure %>% add_trace(y = ~I, name = 'Infected', line = list(color = 'rgb(22, 96, 167)', width = 4))
#     figure <- figure %>% add_trace(y = ~R, name = 'Recovered', line = list(color = 'rgb(202, 96, 167)', width = 4))
#     figure <- figure %>% layout(title = "Main Title of the Plot",
#                                 xaxis = list(title = "Title X axis"),
#                                 yaxis = list(title = "Title Y axis"))}
# )


library(shiny)
#Defining UI ------
ui <- fluidPage(titlePanel("Covid-19 Prediction Model"),


                sidebarLayout(
                  #Total population
                  sidebarPanel(
                    numericInput(
                      "total_pop",
                      "Total population",
                      value = 9000000,
                      min = 1
                    ),
                    numericInput(
                      #Infected number
                      "infected",
                      "Number of infected",
                      value = 440,
                      min = 1
                    ),
                    numericInput(
                      #Recovered
                      "recovered",
                      "Number of recovered",
                      value = 0,
                      min = 1
                    ),
                    selectInput(
                      "select",
                      label = h3("Select a country to apply a model"),
                      choices = list(
                        "Italy" = 1,
                        "Hubei" = 2,
                        "Korea" = 3,
                        "Iran" = 4
                      ),
                      selected = 1
                    ),


                    hr(),
                    fluidRow(column(3, verbatimTextOutput("value")))
                  ),

                  mainPanel(tableOutput("output_function"))
                )
)

#Defining server logic -----
server <- function(input, output, session) {

  #puxar valores de cada input ...e atualizá-los
    TotalPop <- reactive({as.numeric(input$total_pop)})
    InitCases <- reactive({as.numeric(input$infected)})
    Si <- reactive({(TotalPop()-InitCases()) / TotalPop()})
    Ii <- reactive({InitCases() / TotalPop()})
    pars <- reactive({locDF[, as.numeric(input$select)]})

    FunLoopSIR3RoSIR(Si(), Ii(), pars()[1], pars()[2], pars()[3], pars()[3], pars()[5], pars()[6], x)


  observeEvent(input$select, {

  })
  #output$value <- renderPrint({ locDF[, as.numeric(input$select)] })

  #### Recuperacao das variaveis


  # To test
  # ourdataFrame <- reactive({FunLoopSIR3RoSIR(Si, Ii, pars[1], pars[2], pars[3], pars[4], pars[5], pars[6], x)
  # print(ourdataFrame)
  # output$output_function <- renderTable(ourdataFrame)})

  #ourdataFrame <- FunLoopSIR3RoSIR(Si, Ii, pars[1], pars[2], pars[3], pars[3], pars[5], pars[6], x)
}

#Run application -----
shinyApp(ui, server)
